<!doctype html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="xdocs-url-prefix" content="./">

  <meta name="description" content="Ця інструкція наразі не актуальна. Приклад розширення для останньї версії Мавки можна знайти тут: https://github.com/mavka-ukr/hello_mavka_extension.">

  <title>Створюємо розширення Мавки | Часопис Мавки</title>

  <link rel="icon" type="image/png" href="./ресурси/тема/часопис.лого.png" />
  <link rel="icon" sizes="any" type="image/svg+xml" href="./ресурси/тема/часопис.лого.svg">

  <link rel="stylesheet" href="./ресурси/ядро/highlight-atom-one-dark.css">
<link rel="stylesheet" href="./ресурси/тема/тема.css">
</head>
<body>

<div class="XDocsPage">
  <div class="XDocsPageNavigation" data-is-navigation="true" data-hidden-on-mobile="true"><div class="XDocsPageNavigationHead">
  <a href="./index.html" class="XDocsPageNavigationHeadLogo">
    <img src="./ресурси/тема/часопис.лого.svg" alt="">
  </a>
</div>
<div class="XDocsPageNavigationSearch">
  <button>Пошук... (Alt + /)</button>
  <iframe src="./ресурси/search.html"></iframe>
</div>
<a
  href="./index.html"
  class="XDocsPageNavigationItem "
  data-navigation-item="Вступ"
>
  Вступ
</a>
<button
  class="XDocsPageNavigationItem"
  data-navigation-item="Травень 2025"
  data-navigation-item-expanded="false">
  Травень 2025
  <span class="XDocsPageNavigationItemArrow">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
      <path d="M480-357.85 253.85-584 296-626.15l184 184 184-184L706.15-584 480-357.85Z"></path>
    </svg>
  </span>
</button>
<div
  class="XDocsPageNavigationSubmenu"
  data-navigation-submenu="Травень 2025"
  data-navigation-submenu-shown="false"
>
  <a
  href="./2025-05-26-мавка-0-121-0.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Цикл подій, tcp, планувальник - Мавка 0.121.0"
>
  Цикл подій, tcp, планувальник - Мавка 0.121.0
</a>
</div>
<button
  class="XDocsPageNavigationItem"
  data-navigation-item="Лютий 2025"
  data-navigation-item-expanded="false">
  Лютий 2025
  <span class="XDocsPageNavigationItemArrow">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
      <path d="M480-357.85 253.85-584 296-626.15l184 184 184-184L706.15-584 480-357.85Z"></path>
    </svg>
  </span>
</button>
<div
  class="XDocsPageNavigationSubmenu"
  data-navigation-submenu="Лютий 2025"
  data-navigation-submenu-shown="false"
>
  <a
  href="./2025-02-28-будуємо-мавку-на-linux-швидкий-спосіб.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Будуємо Мавку на GNU/Linux (швидкий спосіб)"
>
  Будуємо Мавку на GNU/Linux (швидкий спосіб)
</a>
<a
  href="./2025-02-28-будуємо-мавку-на-linux.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Будуємо Мавку на GNU/Linux"
>
  Будуємо Мавку на GNU/Linux
</a>
<a
  href="./2025-02-27-новий-розбирач-мавки.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Новий розбирач Мавки"
>
  Новий розбирач Мавки
</a>
<a
  href="./2025-02-14-оновлення-теорії-мавки.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Оновлення Теорії Мавки"
>
  Оновлення Теорії Мавки
</a>
<a
  href="./2025-02-14-переїзд-вебсервісів-мавки.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Переїзд вебсервісів Мавки"
>
  Переїзд вебсервісів Мавки
</a>
</div>
<button
  class="XDocsPageNavigationItem"
  data-navigation-item="Січень 2025"
  data-navigation-item-expanded="false">
  Січень 2025
  <span class="XDocsPageNavigationItemArrow">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
      <path d="M480-357.85 253.85-584 296-626.15l184 184 184-184L706.15-584 480-357.85Z"></path>
    </svg>
  </span>
</button>
<div
  class="XDocsPageNavigationSubmenu"
  data-navigation-submenu="Січень 2025"
  data-navigation-submenu-shown="false"
>
  <a
  href="./2025-01-03-дієкод.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Дієкод"
>
  Дієкод
</a>
<a
  href="./2025-01-01-порядок-5.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Порядок 5.0"
>
  Порядок 5.0
</a>
</div>
<button
  class="XDocsPageNavigationItem"
  data-navigation-item="Грудень 2024"
  data-navigation-item-expanded="true">
  Грудень 2024
  <span class="XDocsPageNavigationItemArrow">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
      <path d="M480-357.85 253.85-584 296-626.15l184 184 184-184L706.15-584 480-357.85Z"></path>
    </svg>
  </span>
</button>
<div
  class="XDocsPageNavigationSubmenu"
  data-navigation-submenu="Грудень 2024"
  data-navigation-submenu-shown="true"
>
  <a
  href="./2024-12-04-керування-памʼятю-і-теорія-мавки.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="Теорія Мавки і керування памʼятю"
>
  Теорія Мавки і керування памʼятю
</a>
<a
  href="./2024-12-01-створюємо-розширення-мавки.html"
  class="XDocsPageNavigationSubmenuItem active"
  data-navigation-item="Створюємо розширення Мавки"
>
  Створюємо розширення Мавки
</a>
</div>
<button
  class="XDocsPageNavigationItem"
  data-navigation-item="Вересень 2024"
  data-navigation-item-expanded="false">
  Вересень 2024
  <span class="XDocsPageNavigationItemArrow">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
      <path d="M480-357.85 253.85-584 296-626.15l184 184 184-184L706.15-584 480-357.85Z"></path>
    </svg>
  </span>
</button>
<div
  class="XDocsPageNavigationSubmenu"
  data-navigation-submenu="Вересень 2024"
  data-navigation-submenu-shown="false"
>
  <a
  href="./2024-09-08-реформа.html"
  class="XDocsPageNavigationSubmenuItem "
  data-navigation-item="У Мавки реформа!"
>
  У Мавки реформа!
</a>
</div>
<div class="XDocsPageNavigationFooterWrapper">
  <div class="XDocsPageNavigationFooter">
    <a href="https://мавка.укр"><img src="./ресурси/тема/мавка.лого.svg" alt=""></a>
    Часопис<a href="https://мавка.укр" style="all: unset; cursor: pointer; margin-right: 0.4ch; margin-left: 0.4ch;">Мавки</a>
  </div>
</div>
</div>
  <button data-is-mobile-navigation-toggle="true" class="XDocsPageMobileNavigationToggle">
    <svg data-menu-icon="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
      <path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z" />
    </svg>
    <svg data-close-icon="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"
         fill="currentColor">
      <path
        d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
    </svg>
  </button>
  <div class="XDocsPageContent">
    
    <h1>Як створити просте розширення Мавки?</h1>
<blockquote>
<p>Ця інструкція наразі не актуальна. Приклад розширення для останньї версії Мавки можна знайти тут: <a href="https://github.com/mavka-ukr/hello_mavka_extension">https://github.com/mavka-ukr/hello_mavka_extension</a>.</p>
</blockquote>
<p>Мавку, ще з часів JavaScript версії, можна розширювати. Раніше, очевидно, за допомогою JavaScript. На
щастя, Мавка вже відійша від JS, тому сьогодні розширюватимемо за допомогою Цілі.</p>
<p>У цьому дописі я покажу як просто можна виконувати код на Цілі з Мавки. Але навіть
більше — код на Сі через Ціль з Мавки.</p>
<p>Отож, поїхали. Для цього нам будуть треба останні версії Мавки, Цілі та Clang.
На момент написання
цього допису в мене
версія <a href="https://xn--80ae5bu9f.xn--80aaf6ah.xn--j1amh/%D0%B2%D0%B8%D0%BF%D1%83%D1%81%D0%BA-%D0%BC%D0%B0%D0%B2%D0%BA%D0%B8-0.121.3.html">Мавки 0.121.3</a>,
версія <a href="https://xn--k1avt2b.xn--j1amh">Цілі 0.40.0</a>
та Clang.</p>
<p>Також треба файл <code>РМв1.в.ц</code>.</p>
<p>Структура директорії проекту буде така:</p>
<pre><div class="XDocsCodeWrapper"><code class="hljs">розширення_мавки_сума/
├─ РМв1.в.ц
├─ sum_mavka_extension.c
├─ розширення_мавки_сума.ц.ll
├─ розширення_мавки_сума.so
├─ розширення_мавки_сума.ц
└─ тест_розширення_сума.м
</code></div></pre>
<p>Створюємо файл <code>sum_mavka_extension.c</code> з наступним вмістом:</p>
<pre><div class="XDocsCodeWrapper"><code class="hljs"><span class="hljs-meta">#<span class="hljs-keyword">define</span> р64 double</span>

<span class="hljs-keyword">extern</span> р<span class="hljs-number">64</span> додати_в_сі(р<span class="hljs-number">64</span> а, р<span class="hljs-number">64</span> б) {
  <span class="hljs-keyword">return</span> а + б;
}
</code></div></pre>
<p>Створюємо файл <code>розширення_мавки_сума.ц</code> з наступним вмістом:</p>
<pre><div class="XDocsCodeWrapper"><code class="hljs"><span class="hljs-keyword">взяти</span> <span class="hljs-keyword">визначення</span> РМв1;

<span class="hljs-keyword">зовнішня</span> <span class="hljs-keyword">дія</span> <span class="hljs-title function_">д</span><span class="hljs-title function_">одати_в_сі</span>(а: р64, б: р64): р64;

<span class="hljs-keyword">дія</span> <span class="hljs-title function_">р</span><span class="hljs-title function_">ідна_дія_сума</span>(Р: <span class="hljs-type">адреса</span>&lt;РМв1::Розширення&gt;, предмет_дії: <span class="hljs-type">адреса</span>&lt;РМв1::Предмет&gt;, предмет_я: <span class="hljs-type">адреса</span>&lt;РМв1::Предмет&gt;, кількість_аргументів: <span class="hljs-type">натуральне</span>, аргументи: памʼять&lt;<span class="hljs-type">адреса</span>&lt;РМв1::Предмет&gt;&gt;, іменовані_аргументи: <span class="hljs-type">адреса</span>&lt;РМв1::ІменованіАргументи&gt;): РМв1::ПредметАбоСтанПадіння {
  <span class="hljs-keyword">змінна</span> знайдено_аргумент_а = <span class="hljs-literal">ні</span>;
  <span class="hljs-keyword">змінна</span> аргумент_а: <span class="hljs-type">адреса</span>&lt;РМв1::Предмет&gt; = <span class="hljs-literal">пусто</span>;
  <span class="hljs-keyword">змінна</span> знайдено_аргумент_б = <span class="hljs-literal">ні</span>;
  <span class="hljs-keyword">змінна</span> аргумент_б: <span class="hljs-type">адреса</span>&lt;РМв1::Предмет&gt; = <span class="hljs-literal">пусто</span>;
  <span class="hljs-keyword">якщо</span> іменовані_аргументи != <span class="hljs-literal">пусто</span> {
    знайдено_аргумент_а = РМв1::<span class="hljs-built_in">з</span><span class="hljs-built_in">найти_іменований_аргумент</span>(Р, іменовані_аргументи, РМв1::<span class="hljs-built_in">н</span><span class="hljs-built_in">азва</span>(Р, <span class="hljs-string">&quot;а&quot;</span>), аргумент_а::<span class="hljs-type">адреса</span>);
    знайдено_аргумент_б = РМв1::<span class="hljs-built_in">з</span><span class="hljs-built_in">найти_іменований_аргумент</span>(Р, іменовані_аргументи, РМв1::<span class="hljs-built_in">н</span><span class="hljs-built_in">азва</span>(Р, <span class="hljs-string">&quot;б&quot;</span>), аргумент_б::<span class="hljs-type">адреса</span>);
  }
  <span class="hljs-keyword">якщо</span> знайдено_аргумент_а == <span class="hljs-literal">ні</span> {
    <span class="hljs-keyword">якщо</span> кількість_аргументів &gt; 0 {
      знайдено_аргумент_а = <span class="hljs-literal">так</span>;
      аргумент_а = аргументи[0];
    }
  }
  <span class="hljs-keyword">якщо</span> знайдено_аргумент_б == <span class="hljs-literal">ні</span> {
    <span class="hljs-keyword">якщо</span> кількість_аргументів &gt; 1 {
      знайдено_аргумент_б = <span class="hljs-literal">так</span>;
      аргумент_б = аргументи[1];
    }
  }
  <span class="hljs-keyword">якщо</span> знайдено_аргумент_а == <span class="hljs-literal">ні</span> {
    <span class="hljs-keyword">вернути</span> РМв1::<span class="hljs-built_in">п</span><span class="hljs-built_in">адіння</span>(Р, РМв1::<span class="hljs-built_in">с</span><span class="hljs-built_in">творити_текст</span>(Р, <span class="hljs-string">&quot;Пропущено аргумент \&quot;</span>а\<span class="hljs-string">&quot;&quot;</span>));
  }
  <span class="hljs-keyword">якщо</span> знайдено_аргумент_б == <span class="hljs-literal">ні</span> {
    <span class="hljs-keyword">вернути</span> РМв1::<span class="hljs-built_in">п</span><span class="hljs-built_in">адіння</span>(Р, РМв1::<span class="hljs-built_in">с</span><span class="hljs-built_in">творити_текст</span>(Р, <span class="hljs-string">&quot;Пропущено аргумент \&quot;</span>б\<span class="hljs-string">&quot;&quot;</span>));
  }
  <span class="hljs-keyword">якщо</span> РМв1::<span class="hljs-built_in">п</span><span class="hljs-built_in">еревірити_чи_предмет_є_числом</span>(Р, аргумент_а) == <span class="hljs-literal">ні</span> {
    <span class="hljs-keyword">вернути</span> РМв1::<span class="hljs-built_in">п</span><span class="hljs-built_in">адіння</span>(Р, РМв1::<span class="hljs-built_in">с</span><span class="hljs-built_in">творити_текст</span>(Р, <span class="hljs-string">&quot;Аргумент \&quot;</span>а\<span class="hljs-string">&quot; має бути числом&quot;</span>));
  }
  <span class="hljs-keyword">якщо</span> РМв1::<span class="hljs-built_in">п</span><span class="hljs-built_in">еревірити_чи_предмет_є_числом</span>(Р, аргумент_б) == <span class="hljs-literal">ні</span> {
    <span class="hljs-keyword">вернути</span> РМв1::<span class="hljs-built_in">п</span><span class="hljs-built_in">адіння</span>(Р, РМв1::<span class="hljs-built_in">с</span><span class="hljs-built_in">творити_текст</span>(Р, <span class="hljs-string">&quot;Аргумент \&quot;</span>б\<span class="hljs-string">&quot; має бути числом&quot;</span>));
  }
  <span class="hljs-keyword">змінна</span> а = РМв1::<span class="hljs-built_in">о</span><span class="hljs-built_in">тримати_значення_числа</span>(Р, аргумент_а);
  <span class="hljs-keyword">змінна</span> б = РМв1::<span class="hljs-built_in">о</span><span class="hljs-built_in">тримати_значення_числа</span>(Р, аргумент_б);
  <span class="hljs-keyword">змінна</span> результат = <span class="hljs-built_in">д</span><span class="hljs-built_in">одати_в_сі</span>(а, б);
  <span class="hljs-keyword">вернути</span> РМв1::<span class="hljs-built_in">с</span><span class="hljs-built_in">творити_число</span>(Р, результат);
}

<span class="hljs-keyword">зовнішня</span> <span class="hljs-keyword">дія</span> <span class="hljs-title function_">з</span><span class="hljs-title function_">авантажити_РМв1</span>(Р: <span class="hljs-type">адреса</span>&lt;РМв1::Розширення&gt;): РМв1::ПредметАбоСтанПадіння {
  <span class="hljs-keyword">вернути</span> РМв1::<span class="hljs-built_in">с</span><span class="hljs-built_in">творити_рідну_дію</span>(
    Р, 
    РМв1::<span class="hljs-built_in">н</span><span class="hljs-built_in">азва</span>(Р, <span class="hljs-string">&quot;сума&quot;</span>), 
    0,
    <span class="hljs-literal">пусто</span>,
    <span class="hljs-literal">пусто</span>,
    рідна_дія_сума
  );
}
</code></div></pre>
<p>Компілюємо shared object <code>розширення_мавки_сума.so</code> за допомогою наступних команд:</p>
<pre><div class="XDocsCodeWrapper"><code class="hljs">ціль розширення_мавки_сума.ц.ll скомпілювати розширення_мавки_сума.ц
</code></div></pre>
<pre><div class="XDocsCodeWrapper"><code class="hljs">clang -shared -fPIC -o розширення_мавки_сума.so розширення_мавки_сума.ц.ll sum_mavka_extension.c
</code></div></pre>
<p>Створюємо модуль Мавки <code>тест_розширення_сума.м</code>:</p>
<pre><div class="XDocsCodeWrapper"><code class="hljs"><span class="hljs-keyword">взяти</span> <span class="hljs-keyword">біб</span> мавка

розширення_мавки_сума = мавка.<span class="hljs-title function_">з</span><span class="hljs-title function_">авантажити_РМв1</span>(ю<span class="hljs-string">&quot;./розширення_мавки_сума.so&quot;</span>)

<span class="hljs-title function_">д</span><span class="hljs-title function_">рук</span>(розширення_мавки_сума.<span class="hljs-title function_">з</span><span class="hljs-title function_">начення</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>))
</code></div></pre>
<p>Пробуємо:</p>
<pre><div class="XDocsCodeWrapper"><code class="hljs">мавка тест_розширення_сума.м
</code></div></pre>
<p>Має надрукувати <code>4</code>.</p>
<p>Отож, як видно, виконувати нативний код на Цілі чи Сі з Мавки досить просто.
Головне розібратись з файлом <code>РМв1.в.ц</code> та вміти працювати з Ціллю.</p>
<hr>
<p><em>Написав <a href="https://xn--90afr.xn--j1amh">Давид</a>. Опубліковано 01.12.2024. Оновлено 17.07.2025.</em></p>

    
    <div class="XDocsPageContentBcFw">
      <a data-is-prev="true" href="./2024-12-04-керування-памʼятю-і-теорія-мавки.html">Відступ</a>
      <a data-is-next="true" href="./2024-09-08-реформа.html">Наступ</a >
    </div>
  </div>
</div>

<script src="./ресурси/ядро/ядро.js"></script>
<script src="./ресурси/тема/тема.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DCB6ENR1SK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DCB6ENR1SK');
</script>
</body>
</html>